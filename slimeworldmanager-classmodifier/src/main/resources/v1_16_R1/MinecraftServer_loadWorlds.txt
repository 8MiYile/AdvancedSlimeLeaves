{
    net.minecraft.server.v1_16_R1.WorldServer[] defaultWorlds = (net.minecraft.server.v1_16_R1.WorldServer[]) com.grinderwolf.swm.clsm.ClassModifier.getDefaultWorlds();

    if (defaultWorlds != null) {
        for (int worldId = 0; worldId < 3; ++worldId) {
            WorldServer world = defaultWorlds[index];
            WorldDataServer worlddata;
            byte dimension = 0;
            ResourceKey<WorldDimension> dimensionKey = WorldDimension.OVERWORLD;

            if (worldId == 1) {
                if (getAllowNether()) {
                    dimension = -1;
                    dimensionKey = WorldDimension.THE_NETHER;
                } else {
                    continue;
                }
            }

            if (worldId == 2) {
                if (server.getAllowEnd()) {
                    dimension = 1;
                    dimensionKey = WorldDimension.THE_END;
                } else {
                    continue;
                }
            }

            String worldType = org.bukkit.World.Environment.getEnvironment(dimension).toString().toLowerCase();
            String name = (dimension == 0) ? $1 : $1 + "_" + worldType;
            Convertable.ConversionSession worldSession;
            if (dimension == 0) {
                worldSession = $0.convertable;
            } else {
                try {
                    worldSession = Convertable.a(server.getWorldContainer().toPath()).c(name, dimensionKey);
                } catch (IOException ex) {
                    throw new RuntimeException(ex);
                }
            }

            org.bukkit.generator.ChunkGenerator gen = $0.server.getGenerator(name);

            IRegistryCustom.Dimension iregistrycustom_dimension = IRegistryCustom.b();

            RegistryReadOps<NBTBase> registryreadops = RegistryReadOps.a((DynamicOps) DynamicOpsNBT.a, $0.dataPackResources.h(), (IRegistryCustom) iregistrycustom_dimension);
            worlddata = (WorldDataServer) worldSession.a((DynamicOps) registryreadops, datapackconfiguration);
            if (worlddata == null) {
                WorldSettings worldsettings;
                GeneratorSettings generatorsettings;

                if ($0.isDemoMode()) {
                    worldsettings = MinecraftServer.c;
                    generatorsettings = GeneratorSettings.b;
                } else {
                    DedicatedServerProperties dedicatedserverproperties = ((DedicatedServer) $0).getDedicatedServerProperties();

                    worldsettings = new WorldSettings(dedicatedserverproperties.levelName, dedicatedserverproperties.gamemode, dedicatedserverproperties.hardcore, dedicatedserverproperties.difficulty, false, new GameRules(), datapackconfiguration);
                    generatorsettings = options.has("bonusChest") ? dedicatedserverproperties.generatorSettings.k() : dedicatedserverproperties.generatorSettings;
                }

                worlddata = new WorldDataServer(worldsettings, generatorsettings, Lifecycle.stable());
            }
            worlddata.checkName(name); // CraftBukkit - Migration did not rewrite the level.dat; This forces 1.8 to take the last loaded world as respawn (in $0 case the end)
            if (options.has("forceUpgrade")) {
                net.minecraft.server.Main.convertWorld(worldSession, DataConverterRegistry.a(), options.has("eraseCache"), () -> {
                    return true;
                }, worlddata.getGeneratorSettings().e().c().stream().map((entry) -> {
                    return ResourceKey.a(IRegistry.ad, ((ResourceKey) entry.getKey()).a());
                }).collect(ImmutableSet.toImmutableSet()));
            }

            IWorldDataServer iworlddataserver = worlddata;
            GeneratorSettings generatorsettings = worlddata.getGeneratorSettings();
            boolean flag = generatorsettings.isDebugWorld();
            long i = generatorsettings.getSeed();
            long j = BiomeManager.a(i);
            List<MobSpawner> list = ImmutableList.of(new MobSpawnerPhantom(), new MobSpawnerPatrol(), new MobSpawnerCat(), new VillageSiege(), new MobSpawnerTrader(iworlddataserver));
            RegistryMaterials<WorldDimension> registrymaterials = generatorsettings.e();
            WorldDimension worlddimension = (WorldDimension) registrymaterials.a(dimensionKey);
            DimensionManager dimensionmanager;
            ChunkGenerator chunkgenerator;

            if (worlddimension == null) {
                dimensionmanager = DimensionManager.a();
                chunkgenerator = GeneratorSettings.a((new Random()).nextLong());
            } else {
                dimensionmanager = worlddimension.b();
                chunkgenerator = worlddimension.c();
            }

            ResourceKey<DimensionManager> typeKey = (ResourceKey) $0.f.a().c(dimensionmanager).orElseThrow(() -> {
                return new IllegalStateException("Unregistered dimension type: " + dimensionmanager);
            });
            ResourceKey<World> worldKey = ResourceKey.a(IRegistry.ae, dimensionKey.a());

            if (worldId == 0) {
                if(world == null) {
                    $0.saveData = worlddata;
                    $0.saveData.setGameType(((DedicatedServer) $0).getDedicatedServerProperties().gamemode); // From DedicatedServer.init

                    WorldLoadListener worldloadlistener = $0.worldLoadListenerFactory.create(11);

                    world = new WorldServer($0, $0.executorService, worldSession, iworlddataserver, worldKey, typeKey, dimensionmanager, worldloadlistener, chunkgenerator, flag, j, list, true, org.bukkit.World.Environment.getEnvironment(dimension), gen);
                }

                WorldPersistentData worldpersistentdata = world.getWorldPersistentData();
                $0.initializeScoreboards(worldpersistentdata);
                $0.server.scoreboardManager = new org.bukkit.craftbukkit.scoreboard.CraftScoreboardManager($0, world.getScoreboard());
                $0.persistentCommandStorage = new PersistentCommandStorage(worldpersistentdata);
            } else if(world == null) {
                WorldLoadListener worldloadlistener = $0.worldLoadListenerFactory.create(11);
                world = new WorldServer($0, $0.executorService, worldSession, iworlddataserver, worldKey, typeKey, dimensionmanager, worldloadlistener, chunkgenerator, flag, j, ImmutableList.of(), true, org.bukkit.World.Environment.getEnvironment(dimension), gen);
            }

            worlddata.a($0.getServerModName(), $0.getModded().isPresent());
            $0.initWorld(world, worlddata, saveData, worlddata.getGeneratorSettings());
            $0.server.getPluginManager().callEvent(new org.bukkit.event.world.WorldInitEvent(world.getWorld()));

            $0.worldServer.put(world.getDimensionKey(), world);
            $0.getPlayerList().setPlayerFileData(world);

            if (worlddata.getCustomBossEvents() != null) {
                $0.getBossBattleCustomData().load(worlddata.getCustomBossEvents());
            }
        }
        $0.updateWorldSettings();
        for (WorldServer worldserver : $0.getWorlds()) {
            $0.loadSpawn(worldserver.getChunkProvider().playerChunkMap.worldLoadListener, worldserver);
            $0.server.getPluginManager().callEvent(new org.bukkit.event.world.WorldLoadEvent(worldserver.getWorld()));
        }

        $0.server.enablePlugins(org.bukkit.plugin.PluginLoadOrder.POSTWORLD);
        $0.server.getPluginManager().callEvent(new ServerLoadEvent(ServerLoadEvent.LoadType.STARTUP));
        $0.serverConnection.acceptConnections();
        // CraftBukkit end
    }
}